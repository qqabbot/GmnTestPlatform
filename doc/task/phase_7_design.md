# Product Design: Phase 7 - Test Scenario Orchestration (Test Plan Redesign)

## 1. æ ¸å¿ƒç†å¿µè½¬å˜ (Core Concept Shift)

ç›®å‰çš„ "Test Plan" ä»…æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨ä¾‹é›†åˆï¼ˆListï¼‰ï¼Œé€»è¾‘è¿‡äºæ‰å¹³ã€‚æˆ‘ä»¬éœ€è¦å°†å…¶å‡çº§ä¸º **"æµ‹è¯•åœºæ™¯ (Test Scenario)"** æˆ– **"ä¸šåŠ¡æµ (Business Workflow)"**ã€‚

| ç»´åº¦ | æ—§ç‰ˆ Test Plan | æ–°ç‰ˆ Test Scenario |
| :--- | :--- | :--- |
| **ç»“æ„** | æ‰å¹³åˆ—è¡¨ (List) | æ ‘å½¢/å±‚çº§ç»“æ„ (Tree/Hierarchical) |
| **æ§åˆ¶æµ** | ä»…é¡ºåºæ‰§è¡Œ | æ”¯æŒ **å¾ªç¯ (Loop)**, **åˆ¤æ–­ (If-Else)**, **ç­‰å¾… (Wait)**, **åˆ†ç»„ (Group)** |
| **æ•°æ®æµ** | éšå¼ä¾èµ–å…¨å±€å˜é‡ | æ˜¾å¼ **ä¸Šä¸‹æ–‡ä¼ é€’**, æ­¥éª¤é—´å‚æ•°å¼•ç”¨ (Step Reference) |
| **äº¤äº’æ¨¡å¼** | å·¦å³ç©¿æ¢­æ¡† (Transfer) | **æ‹–æ‹½ç¼–æ’ (Drag & Drop)** + **Canvas/Tree View** |
| **å¤ç”¨æ€§** | å¼•ç”¨ç”¨ä¾‹ | å¼•ç”¨ç”¨ä¾‹ + å¼•ç”¨å…¶ä»–åœºæ™¯ (Nested Scenarios) |

---

## 2. UI/UX äº¤äº’è®¾è®¡ (Redesigned UI)

æˆ‘ä»¬å°†åºŸå¼ƒæ—§çš„ "å·¦å³åˆ—è¡¨" åŠ "å¼¹çª—ç¼–è¾‘" æ¨¡å¼ï¼Œé‡‡ç”¨ç±»ä¼¼ IDE æˆ– Apifox/Postman Runner çš„ **ä¸‰æ å¼ç¼–æ’å¸ƒå±€**ã€‚

### 2.1 å¸ƒå±€ç»“æ„ (Layout)

*   **å·¦ä¾§ï¼šèµ„æºåº“ (Resource Library)**
    *   å±•ç¤ºé¡¹ç›®ä¸‹çš„ API åˆ—è¡¨ã€åŸºç¡€ç”¨ä¾‹åº“ã€è‡ªå®šä¹‰è„šæœ¬åº“ã€‚
    *   æ”¯æŒ **æ‹–æ‹½ (Drag)** åŠ¨ä½œï¼Œå°†å·¦ä¾§çš„ç”¨ä¾‹ç›´æ¥æ‹–å…¥ä¸­é—´ç¼–æ’åŒºã€‚

*   **ä¸­é—´ï¼šç¼–æ’ç”»å¸ƒ/æ ‘ (Orchestration Canvas/Tree)**
    *   è¿™æ˜¯æ ¸å¿ƒå·¥ä½œåŒºã€‚ä¸å†æ˜¯ç®€å•çš„è¡¨æ ¼ï¼Œè€Œæ˜¯ä¸€ä¸ª **å¯è§†åŒ–çš„æ­¥éª¤æ ‘**ã€‚
    *   **èŠ‚ç‚¹ç±»å‹**ï¼š
        *   `API Case`: å¼•ç”¨åŸºç¡€ç”¨ä¾‹ã€‚
        *   `Group`: é€»è¾‘åˆ†ç»„ï¼ˆå¦‚ "ç™»å½•æ¨¡å—", "ä¸‹å•æµç¨‹"ï¼‰ã€‚
        *   `Controller`: å¾ªç¯æ§åˆ¶å™¨ (Loop), æ¡ä»¶æ§åˆ¶å™¨ (If), ç­‰å¾…æ§åˆ¶å™¨ (Wait)ã€‚
        *   `Script`: ç‹¬ç«‹è„šæœ¬æ­¥éª¤ (Groovy)ã€‚
    *   **æ“ä½œ**ï¼šæ‹–æ‹½æ’åºã€åµŒå¥—ã€ç¦ç”¨/å¯ç”¨ã€å¤åˆ¶/ç²˜è´´ã€‚

*   **å³ä¾§ï¼šå±æ€§é…ç½® (Properties Panel)**
    *   é€‰ä¸­ä¸­é—´æŸä¸ªæ­¥éª¤æ—¶ï¼Œå³ä¾§æ˜¾ç¤ºè¯¦ç»†é…ç½®ã€‚
    *   **å¯¹äº API èŠ‚ç‚¹**ï¼š
        *   **æ•°æ®è¦†å†™ (Data Override)**: ä¿®æ”¹è¯¥æ­¥éª¤ç‰¹å®šçš„ Header/Body/Paramsã€‚
        *   **æå–å˜é‡ (Extract)**: å®šä¹‰æ‰§è¡Œåå°†å“ªäº›å“åº”å­—æ®µæå–ä¸ºä¸´æ—¶å˜é‡ã€‚
        *   **æ–­è¨€ (Assert)**: å¢åŠ è¯¥åœºæ™¯ç‰¹æœ‰çš„æ–­è¨€ã€‚
    *   **å¯¹äºæ§åˆ¶å™¨èŠ‚ç‚¹**ï¼šé…ç½®å¾ªç¯æ¬¡æ•°ã€åˆ¤æ–­æ¡ä»¶ç­‰ã€‚

### 2.2 è¿è¡Œä½“éªŒ (Execution UX)

*   **å®æ—¶æ—¥å¿—æµ**ï¼šä¸å†ç­‰å¾…å…¨éƒ¨è·‘å®Œæ‰å‡ºç»“æœã€‚ç‚¹å‡» "è¿è¡Œ" åï¼Œåº•éƒ¨å¼¹å‡ºæ§åˆ¶å°ï¼Œå®æ—¶æ‰“å°æ‰§è¡Œåˆ°çš„æ­¥éª¤ã€çŠ¶æ€ã€è€—æ—¶ã€‚
*   **å¯è§†åŒ–è¿›åº¦**ï¼šä¸­é—´çš„æ­¥éª¤æ ‘åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ Icon å˜åŒ– (Loading -> Check/Cross) å®æ—¶åé¦ˆå½“å‰è¿›åº¦ã€‚
*   **äº¤äº’å¼è°ƒè¯•**ï¼š(é«˜çº§ç‰¹æ€§) æ”¯æŒ "æ–­ç‚¹ (Breakpoint)" æˆ– "å•æ­¥æ‰§è¡Œ"ï¼Œæ–¹ä¾¿è°ƒè¯•å¤æ‚æµç¨‹ã€‚

---

## 3. åŠŸèƒ½ç‰¹æ€§è¯¦è§£ (Feature Specs)

### 3.1 æµç¨‹æ§åˆ¶ (Control Flow)
è¿™æ˜¯ç›®å‰æœ€ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œå¿…é¡»è¡¥å…¨ä»¥æ”¯æŒå¤æ‚ä¸šåŠ¡æµ‹è¯•ã€‚

1.  **æ¡ä»¶åˆ†æ”¯ (If Controller)**
    *   é…ç½®ï¼š`Variable == Value` æˆ– Groovy è¡¨è¾¾å¼ã€‚
    *   é€»è¾‘ï¼šæ»¡è¶³æ¡ä»¶æ‰§è¡Œå­æ­¥éª¤ï¼Œå¦åˆ™è·³è¿‡ã€‚
2.  **å¾ªç¯æ§åˆ¶å™¨ (Loop/ForEach Controller)**
    *   **Count Loop**: å›ºå®šå¾ªç¯ N æ¬¡ã€‚
    *   **ForEach Loop**: éå†ä¸€ä¸ªåˆ—è¡¨å˜é‡ï¼ˆå¦‚ä»æ•°æ®åº“æŸ¥è¯¢å‡ºçš„ ID åˆ—è¡¨ï¼‰ï¼Œä¸ºåˆ—è¡¨æ¯ä¸€é¡¹æ‰§è¡Œä¸€æ¬¡å­æ­¥éª¤ã€‚
    *   **While Loop**: åªè¦æ»¡è¶³æ¡ä»¶å°±ä¸€ç›´æ‰§è¡Œï¼ˆéœ€è®¾ç½®æœ€å¤§å¾ªç¯æ¬¡æ•°é˜²æ­»é”ï¼‰ã€‚
3.  **ç­‰å¾…æ§åˆ¶å™¨ (Wait Controller)**
    *   åœºæ™¯ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œå‘å®Œè¯·æ±‚åéœ€ç­‰å¾… 5ç§’ å†æŸ¥ç»“æœã€‚

### 3.2 æ•°æ®ä¼ é€’ (Data Flow) - "ä¸Šä¸‹æ¸¸ä¼ å‚"
è§£å†³ "ç”¨ä¾‹Aäº§ç”Ÿçš„æ•°æ®ï¼Œå¦‚ä½•ç»™ç”¨ä¾‹Bç”¨" çš„é—®é¢˜ã€‚

*   **æ˜¾å¼æå– (Explicit Extract)**: åœ¨æ­¥éª¤ A é…ç½® "Post-Processors" -> "Extract Variable"ã€‚
    *   æ¥æºï¼šJSONPath / Regex / Headerã€‚
    *   ç›®æ ‡ï¼š`Scenario Variable` (ä»…æœ¬åœºæ™¯æœ‰æ•ˆ) æˆ– `Global Variable`ã€‚
*   **æ˜¾å¼å¼•ç”¨ (Explicit Reference)**: åœ¨æ­¥éª¤ B çš„å‚æ•°ä¸­ï¼Œé€šè¿‡ UI é€‰æ‹©å™¨ç›´æ¥é€‰æ‹© "æ­¥éª¤A çš„ å“åº”ç»“æœ.id"ã€‚
    *   è¯­æ³•ä¼˜åŒ–ï¼šé™¤äº† `${var}`ï¼Œæ”¯æŒæ™ºèƒ½æç¤º `{{StepA.response.body.data.id}}`ã€‚

### 3.3 æµ‹è¯•æŠ¥å‘Š (Report)
*   **èšåˆè§†å›¾**ï¼šæŒ‰åœºæ™¯ -> æ­¥éª¤ çš„å±‚çº§å±•ç¤ºç»“æœã€‚
*   **å¤±è´¥åˆ†æ**ï¼šé«˜äº®å¤±è´¥æ­¥éª¤ï¼Œå±•ç¤ºè¯·æ±‚/å“åº”å¿«ç…§ã€‚
*   **å†å²è¶‹åŠ¿**ï¼šè¯¥åœºæ™¯è¿‘ 10 æ¬¡è¿è¡Œçš„æˆåŠŸç‡æ›²çº¿ã€‚

---

## 4. æŠ€æœ¯æ¶æ„å˜æ›´ (Architecture Changes)

### 4.1 æ•°æ®åº“æ¨¡å‹ (Data Model)
æ—§çš„ `test_plan_cases` å…³è”è¡¨å·²ä¸è¶³ä»¥æ”¯æ’‘ã€‚éœ€è¦æ–°çš„ `test_scenarios` å’Œ `test_scenario_steps` è¡¨ï¼ˆæˆ–æ–‡æ¡£å‹ç»“æ„ï¼‰ã€‚

**Entity: TestScenario**
```json
{
  "id": 1,
  "name": "E2E Order Flow",
  "variables": { "env": "dev" } // Scenario-level variables
}
```

**Entity: TestScenarioStep**
è¿™ä¸€å±‚è®¾è®¡ä¸º **é€’å½’/æ ‘å½¢ç»“æ„**ã€‚
```java
class TestScenarioStep {
    Long id;
    Long parentId; // For nesting
    String type;   // "CASE", "GROUP", "LOOP", "IF", "SCRIPT", "WAIT"
    
    // Reference to base case
    Long referenceCaseId;
    
    // Logic Config (Stored as JSON)
    // For Loop: { "count": 5, "listVar": "userIds" }
    // For If: { "condition": "${status} == 'SUCCESS'" }
    String controlLogic;
    
    // Data Overrides (Stored as JSON)
    String dataOverrides;
    
    // Ordering
    Integer orderIndex;
}
```

### 4.2 æ‰§è¡Œå¼•æ“ (Execution Engine)
*   é‡æ„ `TestPlanService`ã€‚
*   å¼•å…¥ **Runner Context**ï¼šç»´æŠ¤å½“å‰è¿è¡Œçš„å˜é‡ä½œç”¨åŸŸæ ˆã€‚
*   å¼•å…¥ **Step Invoker Pattern**ï¼šæ¯ç§ Step Type (Case, Loop, If) å¯¹åº”ä¸€ä¸ª Invoker ç­–ç•¥ç±»ã€‚

---

## 5. å®æ–½è·¯çº¿å›¾ (Implementation Roadmap)

### âœ… Phase 7.0 - å·²å®ŒæˆåŠŸèƒ½

1.  **âœ… Phase 7.1 - åŸºç¡€é‡æ„ (Foundation)** - å·²å®Œæˆ
    *   âœ… åˆ›å»ºæ–°çš„ DB è¡¨ç»“æ„ (`test_scenarios`, `test_scenario_steps`)
    *   âœ… æ­å»ºä¸‰æ å¼ UI æ¡†æ¶ (Vue SplitPanes)
    *   âœ… å®ç°å·¦ä¾§æ‹–æ‹½åˆ°ä¸­é—´çš„åŸºæœ¬äº¤äº’

2.  **âœ… Phase 7.2 - æ ¸å¿ƒå¼•æ“ (Core Engine)** - å·²å®Œæˆ
    *   âœ… å®ç°é¡ºåºæ‰§è¡Œå¼•æ“
    *   âœ… å®ç° Header/Body/URL/Method å‚æ•°è¦†å†™åŠŸèƒ½
    *   âœ… å®ç°å˜é‡æå–ä¸ä¼ é€’

3.  **âœ… Phase 7.3 - é«˜çº§æ§åˆ¶æµ (Control Flow)** - éƒ¨åˆ†å®Œæˆ
    *   âœ… å®ç° Loop (Count, ForEach) / If / Wait æ§åˆ¶å™¨
    *   âœ… å®ç° SCRIPT æ­¥éª¤æ‰§è¡Œ
    *   âœ… å‡çº§æ‰§è¡Œå¼•æ“æ”¯æŒé€’å½’é€»è¾‘
    *   â³ While Loop æ”¯æŒï¼ˆå¾…å®ç°ï¼‰

4.  **â³ Phase 7.4 - ä½“éªŒä¼˜åŒ– (Polishing)** - éƒ¨åˆ†å®Œæˆ
    *   âœ… åŸºæœ¬å®æ—¶æ—¥å¿—æ§åˆ¶å°ï¼ˆSSE æµå¼æ‰§è¡Œï¼‰
    *   â³ è¿è¡ŒæŠ¥å‘Šç¾åŒ–ï¼ˆå¾…å®Œå–„ï¼‰
    *   â³ Dashboard ç»Ÿè®¡ï¼ˆå¾…å®ç°ï¼‰

### ğŸ“‹ Phase 7.1 - åŠŸèƒ½å®Œå–„ï¼ˆå¾…å¼€å§‹ï¼‰

è¯¦è§ [Phase 7.1 ä»»åŠ¡æ¸…å•](./phase7.1_tasks.md)

**ä¸»è¦ä»»åŠ¡**:
- Step Invoker Pattern é‡æ„
- Runner Context ä½œç”¨åŸŸæ ˆ
- While Loop æ”¯æŒ
- åµŒå¥—åœºæ™¯å¼•ç”¨
- æ™ºèƒ½å˜é‡å¼•ç”¨è¯­æ³•
- æ­¥éª¤æ“ä½œåŠŸèƒ½ï¼ˆå¤åˆ¶/ç²˜è´´ã€ç¦ç”¨/å¯ç”¨ï¼‰
- æµ‹è¯•æŠ¥å‘Šå¢å¼º
- æ–­ç‚¹è°ƒè¯•
- å¹¶å‘æ‰§è¡Œæ”¯æŒ
